---
layout: page-with-sidebar
title:  "æ€å™¨Docker"
date:   2024-03-20 9:47:03 +0800
author: reflectt6
categories: "è¿ç»´"
mainTag: "è¿ç»´"
secondaryTag: "é€Ÿé€šç¯å¢ƒ"
hideTag: false
---

## å‰è¨€

è¸©äº†å‘å°±å¾—æ€»ç»“ã€‚ä¹‹å‰èŠ±äº†ä¸¤å¤©æ—¶é—´æŠ˜è…¾ç¼–è¯‘veloxï¼Œè¯´å®è¯è¿™ä¸ªé¡¹ç›®æ˜¯æˆ‘æ¥è§¦è¿‡æœ€éš¾æç¯å¢ƒçš„é¡¹ç›®ã€‚è™½ç„¶ç»™æˆ‘çš„ç²¾ç¥é€ æˆäº†æˆå¨çš„è¾“å‡ºï¼Œä½†æ˜¯å´è®©æˆ‘å‘ç°äº†é€Ÿé€šç¯å¢ƒä¾èµ–çš„æ–¹æ³•ï¼Œå€¼äº†ï¼

æˆ‘åœ¨M1èŠ¯ç‰‡çš„macä¸Šå¤šæ¬¡å°è¯•ç¼–è¯‘ï¼Œè™½ç„¶veloxæœ¬èº«ä¸ºç»™M1ç¯å¢ƒåšäº†é€‚é…ï¼Œä½†æ˜¯æˆ‘ä»ç„¶æ²¡åŠæ³•ç¼–è¯‘æˆåŠŸã€‚åŸå› åœ¨veloxä¾èµ–å¾ˆå¤šå…¶ä»–çš„å¼€æºåº“ï¼Œä¾èµ–çš„è¿™äº›å¼€æºåº“çš„ç‰ˆæœ¬å¤§å¤šä¸æ˜¯æœ€æ–°çš„ï¼ˆå¯ä»¥ç†è§£ï¼Œæ¯•ç«Ÿä¾èµ–ä¸å¤ªå¯èƒ½è·Ÿç€æœ€æ–°ç‰ˆæœ¬èµ°ï¼‰ã€‚ä½†æ˜¯macä¸Šæœ‰ä¸€ä¸ªç‰¹ç‚¹ï¼Œé€šè¿‡brewç­‰åŒ…ç®¡ç†è½¯ä»¶å®‰è£…çš„åº“éƒ½æ˜¯æœ€æ–°çš„ï¼Œè¿™å°±å¯¼è‡´äº†ç¬¬ä¸€ä¸ªé—®é¢˜ï¼š

> ä¾èµ–åº“çš„ç‰ˆæœ¬å¤ªæ–°ï¼Œæ— æ³•ç”¨åšä¾èµ–

veloxæä¾›äº†ä¸€ä¸ªshellç‰ˆæœ¬çš„ä¾èµ–ç®¡ç†å‡½æ•°ï¼Œå¦‚æœåœ¨æœ¬æœºæ‰¾ä¸åˆ°å¯¹åº”çš„ä¾èµ–åº“ï¼Œå°±ä¼šä»githubæ‹‰ä¸€ä¸ªæ—§çš„commit idï¼Œç„¶åæœ¬åœ°ç¼–è¯‘è¿™äº›ä¾èµ–åº“ã€‚è¿™æ—¶å°±æœ‰å‡ºäº†ç¬¬äºŒä¸ªé—®é¢˜ï¼š

> æ—§çš„ä¾èµ–ä¸€èˆ¬éƒ½ä¾èµ–äºæ—§çš„MacOS SDKï¼Œæ–°SDKç¼–è¯‘ä¸äº†

Macç³»ç»Ÿæ¢SDKæ˜¯å¾ˆéº»çƒ¦çš„ï¼Œæˆ‘ä¸ªäººä¹Ÿä¸æƒ³æ¢ï¼Œå› ä¸ºæ–°çš„SDKä¿®å¤äº†å¾ˆå¤šbugï¼Œæˆ‘æ„Ÿè§‰è¿™æ³¢åå‘å‡çº§å¾ˆè ¢ã€‚

è¿™æ˜¯æˆ‘ç¬¬ä¸€æ¬¡æ„Ÿè§‰åœ¨macä¸Šå¼€å‘åŸæ¥è¿™ä¹ˆéº»çƒ¦ã€‚ä½†å…¶å®è¿™æ‰æ˜¯å‰æˆè€Œå·²ï¼Œç›´åˆ°åæ¥æˆ‘æ‰çŸ¥é“ï¼Œveloxç¼–è¯‘å®Œå¾—èŠ±åå‡ ä¸ªå°æ—¶ã€‚è¿™æ˜¯æˆ‘è§è¿‡çš„ç¼–è¯‘æ—¶é—´æœ€é•¿çš„ç»„ä»¶äº†ã€‚

å¦‚ä½•è§£å†³ä¸Šé¢çš„é—®é¢˜å‘¢ï¼Ÿæˆ‘æƒ³çš„è„‘å£³ç–¼ã€‚ä½†å…¶å®ä¸å…‰æˆ‘è„‘å£³ç–¼ï¼Œä¸šç•Œä¹Ÿæ—©å—å¤Ÿäº†ç¯å¢ƒæ„å»ºå¸¦æ¥çš„æ—¶é—´æˆæœ¬å’Œç²¾åŠ›æˆæœ¬ã€‚æ—©åœ¨æˆ‘æ²¡æœ‰å…³æ³¨çš„æ—¶å€™ï¼Œæœ‰ä¸ªä¸œè¥¿æ…¢æ…¢å‘å±•èµ·æ¥ï¼Œæ„åœ¨è§£å†³é…ç½®ç¯å¢ƒå¸¦æ¥çš„è¯¸å¤šä¸ä¾¿ã€‚

> å®ƒå°±æ˜¯--**Docker**



## Dockerçš„å±€é™

`dockerå¯ä»¥é€Ÿé€šç¯å¢ƒä¾èµ–é—®é¢˜ï¼Œä½¿å¾—å¼€å‘ç¯å¢ƒå°½ç„¶æœ‰åºï¼Œä½†æ˜¯ä»ç„¶æ— æ³•è§£å†³æ¶æ„é—®é¢˜ï¼Œå¦‚æœæºä»£ç å¯¹äºæ¶æ„çš„æ”¯æŒä¸å¥½ï¼Œdockerä¹Ÿæ˜¯æ— èƒ½ä¸ºåŠ›çš„ï¼`



## [Docker](https://docs.docker.com/manuals/){:target="_blank"}

[dockerfileæ–‡æ¡£](https://docs.docker.com/reference/dockerfile/){:target="_blank"}

dockerå¯ä»¥é€šè¿‡dockerfileè§„èŒƒã€å¯é€†çš„æ„å»ºæ ‡å‡†ç¯å¢ƒï¼Œä¹‹å‰å·²ç»äº†è§£è¿‡äº†ã€‚ä»Šå¤©çš„ä¸»é¢˜ä¸æ˜¯ä»–ã€‚

### docker run

-vï¼šç”¨æ¥æŒ‡å®šæŒ‚è½½ç›®å½•

> ```shell
> docker run -itd -v /src:/dst centos bash
> ```
>
> å†’å·å‰ä¸ºå®¿ä¸»æœºå†…ç›®å½•ï¼Œå†’å·åä¸ºå®¹å™¨å†…ç›®å½•

--name: è®¾ç½®å®¹å™¨åç§°

-dï¼šåå°è¿è¡Œå®¹å™¨

-iï¼šå…è®¸äº¤äº’ 

--rm : è¿è¡Œå®Œå°±åˆ é™¤å®¹å™¨

```
ä¾‹å­ï¼šdocker run -itd --network host --name gluten ubuntu:22.04 /bin/bash
```

### docker attach

è¿æ¥åˆ°dockerå®¹å™¨ä¸­ï¼Œé€€å‡ºè¿æ¥æ—¶å®¹å™¨è‡ªåŠ¨å…³é—­



### [docker commit](https://blog.csdn.net/github_38924695/article/details/110531410?spm=1001.2014.3001.5506){:target="_blank"}

å°†å®¹å™¨æäº¤ä¸ºä¸€ä¸ªé•œåƒ



### docker inspect ã€é•œåƒidã€‘

æŸ¥çœ‹ä½ åœ¨æœ¬åœ°é•œåƒçš„ cpu æ¶æ„ç±»å‹



## [Docker Compose](https://docs.docker.com/compose/compose-file/){:target="_blank"}

ä»€ä¹ˆæ˜¯Docker Composeï¼Ÿå¯ä»¥å…ˆä»[è¿™ç¯‡æ–‡ç« ](https://www.freecodecamp.org/chinese/news/what-is-docker-compose-how-to-use-it/){:target="_blank"}å¦‚ä¸‹é—¨ã€‚æˆ‘çš„ç†è§£æ˜¯docker composeæ˜¯å°†å¥½å‡ ä¸ªdockerfileç»„åˆèµ·æ¥çš„ä¸€ä¸ªè“å›¾ï¼Œé€šè¿‡é…ç½®æ–‡ä»¶ï¼ˆyamlï¼‰ï¼Œè§„å®šäº†å“ªäº›dockerfileå…ˆå¯åŠ¨ï¼Œå“ªäº›åå¯åŠ¨ï¼ˆå› ä¸ºæœ‰äº›æœåŠ¡å­˜åœ¨å‰åçš„ä¾èµ–å…³ç³»ï¼‰ã€‚å“ªäº›dockerfileè¿è¡Œå“ªäº›å‘½ä»¤ã€‚å°†è¿™äº›dockerfileç»Ÿç»Ÿå¯åŠ¨ä¹‹åï¼Œè¿è¡Œåœ¨åŒä¸€ä¸ªå®¹å™¨ä¸­ï¼Œå…±åŒå®ŒæˆæŸä¸€ä¸ªç›®çš„ï¼Œè¿™å°±æ˜¯Composeï¼ˆç»„åˆï¼‰çš„å«ä¹‰ã€‚

`docker-compose run` å’Œ `docker-compose up` æ˜¯ä¸¤ä¸ªä¸åŒçš„ Docker Compose å‘½ä»¤ï¼Œç”¨é€”å’Œè¡Œä¸ºä¹Ÿæœ‰æ‰€ä¸åŒï¼š

1. **docker-compose run**ï¼š
   - ç”¨é€”ï¼šç”¨äºåœ¨æŒ‡å®šæœåŠ¡çš„å®¹å™¨ä¸­è¿è¡Œç‰¹å®šå‘½ä»¤ã€‚
   - è¯­æ³•ï¼š`docker-compose run <service_name> <command>`
   - ç¤ºä¾‹ï¼š`docker-compose run web python manage.py migrate`
   - æ³¨æ„ï¼šä½¿ç”¨ `docker-compose run` æ—¶ï¼Œä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„å®¹å™¨è¿è¡ŒæŒ‡å®šçš„å‘½ä»¤ï¼Œå‘½ä»¤æ‰§è¡Œå®Œæ¯•åå®¹å™¨ä¼šè¢«åœæ­¢å¹¶åˆ é™¤ã€‚é€‚åˆä¸´æ—¶æ€§çš„ä»»åŠ¡æ‰§è¡Œï¼Œå¦‚è¿è¡Œä¸€æ¬¡æ€§å‘½ä»¤æˆ–æµ‹è¯•ã€‚
2. **docker-compose up**ï¼š
   - ç”¨é€”ï¼šç”¨äºæ„å»ºå¹¶å¯åŠ¨æ•´ä¸ªåº”ç”¨çš„æœåŠ¡ã€‚
   - è¯­æ³•ï¼š`docker-compose up [options] [service...]`
   - ç¤ºä¾‹ï¼š`docker-compose up -d`ï¼ˆåœ¨åå°å¯åŠ¨æœåŠ¡ï¼‰
   - æ³¨æ„ï¼šä½¿ç”¨ `docker-compose up` æ—¶ï¼Œä¼šæ ¹æ® `docker-compose.yml` æ–‡ä»¶ä¸­çš„é…ç½®æ„å»ºé•œåƒå¹¶å¯åŠ¨å®¹å™¨ï¼Œå®¹å™¨ä¼šæŒç»­è¿è¡Œç›´åˆ°æ˜¾å¼åœæ­¢ã€‚é€‚åˆå¯åŠ¨åº”ç”¨çš„å¸¸é©»æœåŠ¡ã€‚

å› æ­¤ï¼Œä¸»è¦åŒºåˆ«åœ¨äº `docker-compose run` ç”¨äºè¿è¡Œä¸´æ—¶å‘½ä»¤ï¼Œè€Œ `docker-compose up` ç”¨äºå¯åŠ¨æ•´ä¸ªåº”ç”¨æœåŠ¡ã€‚



### [å®˜æ–¹æ•™ç¨‹](https://docs.docker.com/compose/compose-file/05-services/){:target="_blank"}

è¯´å®è¯ï¼Œçœ‹è¿™ç§è‹±æ–‡çš„æ–‡æ¡£æˆ‘çœŸæ˜¯æƒ³ğŸ¤®

docker-composeæœ‰V1å’ŒV2ä¸¤ä¸ªç‰ˆæœ¬ï¼Œ[ç›®å‰V1ç‰ˆæœ¬å·²ç»å¼ƒç”¨](https://docs.docker.com/compose/migrate/){:target="_blank"}ã€‚

ä¸€èˆ¬å°†é…ç½®ä¿¡æ¯å†™å…¥yamlæ–‡ä»¶ä¸­

- è¿è¡Œdocker-compose build [serverName] å°±ä¼šå»ymlæ‰¾åˆ°å¯¹åº”serverNameçš„æœåŠ¡ï¼Œç„¶åæ‰¾åˆ°buildé…ç½®è¿›è¡Œæ„å»º
- è¿è¡Œdocker-compose run [serverName] å°±ä¼šå»ymlæ‰¾åˆ°å¯¹åº”serverNameçš„æœåŠ¡ï¼Œç„¶åæ‰¾åˆ°commandé…ç½®è¿›è¡Œæ„å»ºï¼›ä¹Ÿå¯ä»¥docker-compose run [serverName] [command]ç›´æ¥æ‰§è¡Œå‘½ä»¤

è¿™é‡Œçœ‹çœ‹yamlæ–‡ä»¶åº”è¯¥æ€ä¹ˆå†™ï¼Œåƒserviceså°±æ˜¯é¡¶çº§å…ƒç´ ï¼ˆtop-level elementï¼‰ï¼Œ[è¿™é‡Œ](https://docs.docker.com/compose/compose-file/){:target="_blank"}å¯ä»¥çœ‹yamlä¸­æœ‰å“ªäº›é¡¶çº§å…ƒç´ ã€‚æ¯ä¸ªé¡¶çº§å…ƒç´ ç‚¹è¿›å»å¯ä»¥çœ‹æ¬¡çº§å±æ€§ã€‚

æ¯”å¦‚è¿™å°±æ˜¯ä¸€ä¸ªyamlæ–‡ä»¶ï¼Œserviceså±äºé¡¶çº§å…ƒç´ ï¼Œwebã€rediséƒ½æ˜¯æœåŠ¡çš„åç§°ä¹Ÿå°±æ˜¯ä¸Šé¢çš„ [serverName]

```yaml
services:
  web:
    build: .
    ports:
      - "8000:5000"
    volumes:
      - .:/code
    environment:
      FLASK_DEBUG: "true"
  redis:
    image: "redis:alpine"
```

æƒ³çœ‹çœ‹servicesé¡¶çº§å…ƒç´ ä¸‹æœ‰å“ªäº›æ¬¡çº§å±æ€§ï¼Œå¯ä»¥çœ‹[è¿™é‡Œ](https://docs.docker.com/compose/compose-file/05-services/){:target="_blank"}ã€‚

é™¤äº†servicesä¹‹å¤–ï¼Œè¿˜æœ‰versionã€nameã€networksã€volumnesã€configsã€secretså‡ ä¸ªé¡¶çº§å…ƒç´ 

å†æ¥ä¸ªveloxçš„ä¾‹å­

```yaml
version: '3.5'

services:
  ubuntu-cpp:
    # Usage:
    #   docker-compose pull ubuntu-cpp or docker-compose build ubuntu-cpp
    #   docker-compose run --rm ubuntu-cpp
    #   or
    #   docker-compose run -e NUM_THREADS=<NUMBER_OF_THREADS_TO_USE> --rm ubuntu-cpp
    #   to set the number of threads used during compilation
    image: ghcr.io/facebookincubator/velox-dev:amd64-ubuntu-22.04-avx
    build:
      context: .
      dockerfile: scripts/ubuntu-22.04-cpp.dockerfile
    environment:
      NUM_THREADS: 8 # default value for NUM_THREADS
      VELOX_DEPENDENCY_SOURCE: BUNDLED # Build dependencies from source
      CCACHE_DIR: "/velox/.ccache"
    volumes:
      - .:/velox:delegated
    command: scripts/docker-command.sh
```



## Intelliå…¨å®¶æ¡¶è¿œç¨‹è°ƒè¯•dockerå®¹å™¨

é…ç½®[Docker dev container](https://www.jetbrains.com/help/clion/connect-to-devcontainer.html#start_container_from_product){:target="_blank"}

[Dev Container limitations](https://www.jetbrains.com/help/clion/prerequisites-for-dev-containers.html#limitations){:target="_blank"}

å¦‚æœIntelliè½¯ä»¶æä¾›äº†ä»£å¯åŠ¨docker composeçš„æœåŠ¡ï¼Œä½†æ˜¯æˆ‘æ„Ÿè§‰è¿™æ ·ä¸å¥½ï¼Œä¸“ä¸šçš„äººåšä¸“ä¸šçš„äº‹ï¼Œè¿˜æ˜¯ç”¨docker desktopå¯åŠ¨ï¼Œç„¶åé€šè¿‡remoteè¿æ¥ä¸Šå»æ¯”è¾ƒå¥½

[remote è¿æ¥](https://www.jetbrains.com/help/clion/remote-development-a.html#use_idea){:target="_blank"}



## è¸©å‘è®°å½•

1ã€ä¸ºä»€ä¹ˆæˆ‘çš„docker compose å¯åŠ¨å®Œæˆä¹‹åä¼šè‡ªåŠ¨å…³é—­ï¼Ÿ

æˆ‘çœ‹äº†ä¸€ä¸‹é‚£äº›èƒ½é•¿ä¹…è¿è¡Œçš„å®¹å™¨ï¼Œä»–ä»¬çš„commandéƒ½æ˜¯/bin/bashè¿™äº›å¯åŠ¨shellçš„å‘½ä»¤ã€‚å¦‚æœä½ æƒ³è®©å®¹å™¨ä¸è‡ªå·±é€€å‡ºï¼Œéœ€è¦åœ¨commandæœ€ååŠ ä¸Šâ€œ/bin/bashâ€ã€‚

æˆ‘è‡ªå·±çš„ç¼–è¯‘å®¹å™¨å°±æ˜¯å…ˆæŒ‰å¼€æºä»£ç å®Œæˆç¼–è¯‘å’ŒUTï¼Œåœ¨æœ€ååŠ ä¸Šâ€œ;/bin/bashâ€ï¼Œè¿™æ ·å°±å¾—åˆ°äº†ä¸€ä¸ªå¯ä»¥è¿œç¨‹è°ƒè¯•çš„dockerç¯å¢ƒã€‚



2ã€ä¸ªäººå®è·µï¼šåœ¨windowsä¸Šè¿è¡Œubuntuçš„é•œåƒï¼Œç”¨äºç¼–è¯‘veloxï¼Œç¼–è¯‘éå¸¸æ…¢ã€‚

ä¸ç¡®å®šæ˜¯ä¸æ˜¯m1å’Œintel 11ä»£i9å·®ä¸å¤šï¼Ÿç½‘ä¸ŠæŸ¥äº†ä¸€ä¸‹ï¼Œå¥½åƒå·®ä¸å¤šã€‚ã€‚

è¿˜æ˜¯dockeræœ‰å¾ˆå¤šcpuæŸè€—ï¼Ÿ



3ã€ç›®å‰dockerè¿˜æ˜¯å­˜åœ¨ä¸€äº›å¼Šç«¯ï¼Œè™½ç„¶dockeråœ¨ä¸€å®šç¨‹åº¦å±è”½çš„cpuæ¶æ„ï¼Œä½†æ˜¯ä¸åŒæ¶æ„çš„å®¹å™¨ä»ç„¶å­˜åœ¨å·®è·ã€‚æ¯”å¦‚æˆ‘æ— æ³•åœ¨M1èŠ¯ç‰‡çš„dockerå®¹å™¨ä¸­ç¼–è¯‘veloxã€‚













