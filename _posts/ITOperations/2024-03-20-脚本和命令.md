---
layout: page-with-sidebar
title:  "è„šæœ¬å’Œå‘½ä»¤"
date:   2024-03-20 9:47:03 +0800
author: reflectt6
categories: "è¿ç»´"
mainTag: "è¿ç»´"
secondaryTag: "Linux"
hideTag: false
---

## é€Ÿé€šShellè„šæœ¬

shellè„šæœ¬å…¶å®æŒºå¥½ç©çš„ï¼Œè¿™é‡Œç»“åˆå®é™…åº”ç”¨åœºæ™¯ç»™å‡ ä¸ªdemo

### 0ã€è®¾ç½®è„šæœ¬æŠ¥é”™ä¸é€€å‡ºï¼Œç»§ç»­æ‰§è¡Œ

åœ¨shellè„šæœ¬ä¸­ï¼Œä½ å¯ä»¥ä½¿ç”¨ `set` å‘½ä»¤æ¥è®¾ç½®è„šæœ¬çš„è¡Œä¸ºã€‚å…¶ä¸­çš„ `-e` é€‰é¡¹å¯ä»¥è®©è„šæœ¬åœ¨é‡åˆ°é”™è¯¯æ—¶ç«‹å³é€€å‡ºï¼Œè€Œä¸ç»§ç»­æ‰§è¡Œä¸‹å»ã€‚å¦‚æœä½ æƒ³è¦åœ¨é‡åˆ°é”™è¯¯æ—¶ä¸é€€å‡ºï¼Œå¯ä»¥ä½¿ç”¨ `set +e` æ¥å–æ¶ˆè¯¥é€‰é¡¹ã€‚ä»¥ä¸‹æ˜¯ä¸€ä¸ªç¤ºä¾‹ï¼š

```shell
#!/bin/bash

# è®¾ç½®ä¸é€€å‡º
set +e

# è¿™é‡Œä¼šå‡ºç°ä¸€ä¸ªé”™è¯¯ï¼Œä½†è„šæœ¬ä¸ä¼šé€€å‡º
ls /path/to/nonexistent/directory

# å–æ¶ˆè®¾ç½®ï¼Œè®©è„šæœ¬åœ¨é‡åˆ°é”™è¯¯æ—¶ç«‹å³é€€å‡º
set -e

# è¿™é‡Œä¼šå†æ¬¡å‡ºç°é”™è¯¯ï¼Œä½†ç”±äºå·²ç»è®¾ç½®äº† -eï¼Œè„šæœ¬ä¼šç«‹å³é€€å‡º
ls /path/to/nonexistent/directory
echo "è¿™è¡Œä¸ä¼šæ‰§è¡Œåˆ°"
```

åœ¨è¿™ä¸ªç¤ºä¾‹ä¸­ï¼Œè„šæœ¬ä¸­çš„ç¬¬ä¸€ä¸ª `ls` å‘½ä»¤ä¼šå¯¼è‡´ä¸€ä¸ªé”™è¯¯ï¼Œä½†ç”±äºè®¾ç½®äº† `set +e`ï¼Œè„šæœ¬ä¼šç»§ç»­æ‰§è¡Œã€‚è€Œç¬¬äºŒä¸ª `ls` å‘½ä»¤ä¼šå¯¼è‡´è„šæœ¬ç«‹å³é€€å‡ºï¼Œå› ä¸ºåœ¨é‚£ä¹‹å‰å·²ç»è®¾ç½®äº† `set -e`ã€‚

### 1ã€å°†æ–‡ä»¶ä¸­çš„æ‰€æœ‰æ–‡ä»¶æ‘˜å‡ºæ¥ï¼Œåˆ†åˆ«å¤„ç†

ä½¿ç”¨ `hdfs dfs -ls -t /path/to/files > files` åˆ—å‡ºHDFSç›®å½•ä¸‹çš„æ‰€æœ‰æ–‡ä»¶(-t è¡¨ç¤ºæŒ‰ç…§æ—¶é—´æ’åº)ï¼Œå¹¶è¾“å‡ºåˆ°filesæ–‡ä»¶

è¿™æ—¶å€™æˆ‘ä»¬æƒ³å¯¹æ¯ä¸€ä¸ªæ–‡ä»¶åˆ†åˆ«åšä¸€äº›æ“ä½œå¯ä»¥è¿™æ ·æ

```shell
for file in $(cat filesï½œawk '{print $8}'); do
    # åœ¨è¿™é‡Œæ‰§è¡Œå¯¹æ–‡ä»¶çš„æ“ä½œï¼Œä¾‹å¦‚æ‰“å°æ–‡ä»¶å†…å®¹
    echo "File: $file"
    cat $file
done
```

è¿™é‡Œå¯ä»¥é€ä¸ªå¯¹æ–‡ä»¶åšä¿®æ”¹

å¦‚æœæˆ‘ä»¬æƒ³è®©æ‰€æœ‰æ–‡ä»¶ç´¯åŠ èµ·æ¥ï¼Œç”¨äºhdfsè·å–æ“ä½œï¼Œå¯ä»¥è¿™æ ·æ

```shell
str="hdfs dfs -get "
for fileName in $(cat filesï½œawk '{print $8}'); do
    # åœ¨è¿™é‡Œå°†æ–‡ä»¶åç´¯åŠ åˆ°stråé¢
    str=$str" "$fileName
done
str=$str" destinationDir"
$($str)
```

è¿™é‡Œç¨å¾®è§£é‡Šä¸€ä¸‹è¯­æ³•

- `$()`ä¼šå°†æ‹¬å·é‡Œé¢çš„`å­—ç¬¦ä¸²`å½“æˆä¸€æ¡å‘½ä»¤å»æ‰§è¡Œï¼Œå’Œä¸¤ä¸ªåå¼•å·\`\`çš„ä½œç”¨ç±»ä¼¼

å½“ç„¶æˆ‘ä»¬å¯ä»¥ç”¨æ›´ç‰›ä¸€ç‚¹çš„å‘½ä»¤xargsï¼Œå°†å¤šè¡Œè¾“å…¥å˜æˆå•è¡Œè¾“å‡º

```shell
str="hdfs dfs -get "
str=$str`cat filesï½œawk '{print $8}' |xargs`
str=$str" destinationDir"
$($str)
```



### 2ã€shellä¸­å¦‚ä½•å¯¹å­—ç¬¦ä¸²è¿›è¡Œå¤„ç†

åœ¨ shell ä¸­è¿›è¡Œå­—ç¬¦ä¸²å¤„ç†é€šå¸¸æ¶‰åŠåˆ°ä¸€äº›åŸºæœ¬çš„å­—ç¬¦ä¸²æ“ä½œï¼Œæ¯”å¦‚è¿æ¥å­—ç¬¦ä¸²ã€æå–å­å­—ç¬¦ä¸²ã€æ›¿æ¢éƒ¨åˆ†å­—ç¬¦ä¸²ç­‰ã€‚ä¸‹é¢æ˜¯ä¸€äº›å¸¸è§çš„å­—ç¬¦ä¸²å¤„ç†æ“ä½œç¤ºä¾‹ï¼š

1. **è¿æ¥å­—ç¬¦ä¸²**ï¼šä½¿ç”¨ `${var1}${var2}` æˆ–è€… `$var1$var2` æ¥è¿æ¥ä¸¤ä¸ªå­—ç¬¦ä¸²å˜é‡ã€‚

   ```shell
   var1="Hello, "
   var2="world!"
   result="${var1}${var2}"
   echo $result
   ```

2. **æå–å­å­—ç¬¦ä¸²**ï¼šä½¿ç”¨`${var: start: length}` æ¥æå–ä»ä½ç½® `start` å¼€å§‹é•¿åº¦ä¸º `length` çš„å­å­—ç¬¦ä¸²ã€‚

   ```shell
   var="Hello, world!"
   substring="${var:7:5}"
   echo $substring
   ```

3. **å­—ç¬¦ä¸²é•¿åº¦**ï¼šä½¿ç”¨ `${#var}` æ¥è·å–å­—ç¬¦ä¸²çš„é•¿åº¦ã€‚

   ```shell
   var="Hello, world!"
   length="${#var}"
   echo $length
   ```

4. **æŸ¥æ‰¾å­å­—ç¬¦ä¸²**ï¼šä½¿ç”¨ `${var#substring}` æˆ–è€… `${var##substring}` æ¥åˆ é™¤ `var` ä¸­å¼€å¤´çš„åŒ¹é…å­å­—ç¬¦ä¸²ã€‚

   ```shell
   var="Hello, world!"
   result="${var#Hello, }"
   echo $result
   ```

5. **æ›¿æ¢å­å­—ç¬¦ä¸²**ï¼šä½¿ç”¨ `${var/old/new}` æˆ–è€… `${var//old/new}` æ¥æ›¿æ¢ `var` ä¸­çš„ç¬¬ä¸€ä¸ªæˆ–è€…æ‰€æœ‰åŒ¹é…çš„å­å­—ç¬¦ä¸²ã€‚

   ```shell
   var="Hello, world!"
   result="${var/world/John}"
   echo $result
   ```

   

è¿™äº›åªæ˜¯ä¸€äº›åŸºæœ¬çš„ç¤ºä¾‹ï¼Œshell æä¾›äº†ä¸°å¯Œçš„å­—ç¬¦ä¸²å¤„ç†åŠŸèƒ½ï¼Œæ‚¨å¯ä»¥æ ¹æ®å…·ä½“éœ€æ±‚é€‰æ‹©é€‚åˆçš„æ–¹æ³•ã€‚

## Linuxå†·é—¨å‘½ä»¤

### nohup

`nohup` æ˜¯ä¸€ä¸ªåœ¨ Unix å’Œç±» Unix æ“ä½œç³»ç»Ÿä¸Šçš„å‘½ä»¤ï¼Œç”¨äºåœ¨åå°è¿è¡Œå‘½ä»¤ï¼Œå¹¶ä¸”ä¸ä¼šå› ä¸ºç»ˆç«¯çš„å…³é—­è€Œä¸­æ–­ã€‚ä¸‹é¢æ˜¯ `nohup` å‘½ä»¤çš„åŸºæœ¬ç”¨æ³•ï¼š

```bash
nohup command [arguments] &
```

å…¶ä¸­ï¼š

- `command` æ˜¯ä½ æƒ³è¦åœ¨åå°è¿è¡Œçš„å‘½ä»¤ã€‚
- `[arguments]` æ˜¯å‘½ä»¤çš„å‚æ•°ï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰ã€‚
- `&` ç”¨äºå°†å‘½ä»¤æ”¾å…¥åå°è¿è¡Œã€‚

å½“ä½ ä½¿ç”¨ `nohup` å‘½ä»¤åï¼Œå‘½ä»¤ä¼šåœ¨åå°è¿è¡Œï¼Œä¸å—ç»ˆç«¯å…³é—­çš„å½±å“ã€‚åŒæ—¶ï¼Œå‘½ä»¤çš„è¾“å‡ºä¼šé»˜è®¤é‡å®šå‘åˆ°å½“å‰ç›®å½•ä¸‹çš„ `nohup.out` æ–‡ä»¶ä¸­ã€‚

å¦‚æœä½ æƒ³è‡ªå®šä¹‰è¾“å‡ºæ–‡ä»¶çš„è·¯å¾„ï¼Œå¯ä»¥ä½¿ç”¨é‡å®šå‘ç¬¦å· `>`ï¼Œä¾‹å¦‚ï¼š

```bash
nohup command [arguments] > output.log &
```

è¿™å°†æŠŠå‘½ä»¤çš„è¾“å‡ºé‡å®šå‘åˆ° `output.log` æ–‡ä»¶ä¸­ã€‚

å¦‚æœä½ å¸Œæœ›å‘½ä»¤åœ¨åå°è¿è¡Œçš„åŒæ—¶ï¼Œä¸äº§ç”Ÿä»»ä½•è¾“å‡ºæ–‡ä»¶ï¼Œä½ å¯ä»¥å°†è¾“å‡ºé‡å®šå‘åˆ° `/dev/null`ï¼Œä¾‹å¦‚ï¼š

```bash
nohup command [arguments] > /dev/null &
```

è¿™æ ·å°±ä¸ä¼šäº§ç”Ÿä»»ä½•è¾“å‡ºæ–‡ä»¶äº†ã€‚

ä½ ä¹Ÿå¯ä»¥é€šè¿‡ `nohup` çš„å¸®åŠ©æ–‡æ¡£æ¥æŸ¥çœ‹æ›´å¤šé€‰é¡¹å’Œç”¨æ³•ï¼š

```bash
man nohup
```

## LinuxğŸ®é€¼å‘½ä»¤

### grep

- æœç´¢æ–‡æœ¬

  æˆ‘å¸¸ç”¨ `grep -nr "Hello" /dir`ï¼Œ-nè¡¨ç¤ºæ˜¾ç¤ºè¡Œå·ï¼Œ-rè¡¨ç¤ºé€’å½’æŸ¥æ‰¾

- æ’é™¤æ–‡æœ¬

  `grep -v "æ­£åˆ™è¡¨è¾¾å¼"`ï¼Œ-vè¡¨ç¤ºæ’é™¤ï¼Œæ’é™¤æ­£åˆ™è¡¨è¾¾å¼åŒ¹é…åˆ°çš„æ–‡æœ¬

  ä¾‹å¦‚ï¼š`hdfs dfs -ls -t hdfs://server1:9000/spark2-history |grep -v ".inprogress$"ï½œgrep -v ".local." > history`å¯ä»¥æ’é™¤inprogressçŠ¶æ€çš„æ—¥å¿—å’Œä»¥localæ¨¡å¼è¿è¡Œçš„æ—¥å¿—å¹¶è¾“å‡ºåˆ°historyæ–‡ä»¶



### [xargs](https://www.runoob.com/linux/linux-comm-xargs.html)

ä¸€èˆ¬å’Œç®¡é“ä¸€èµ·ç”¨

**å‚æ•°ï¼š**

- -a file ä»æ–‡ä»¶ä¸­è¯»å…¥ä½œä¸º stdin
- -e flag ï¼Œæ³¨æ„æœ‰çš„æ—¶å€™å¯èƒ½ä¼šæ˜¯-Eï¼Œflagå¿…é¡»æ˜¯ä¸€ä¸ªä»¥ç©ºæ ¼åˆ†éš”çš„æ ‡å¿—ï¼Œå½“xargsåˆ†æåˆ°å«æœ‰flagè¿™ä¸ªæ ‡å¿—çš„æ—¶å€™å°±åœæ­¢ã€‚
- -p å½“æ¯æ¬¡æ‰§è¡Œä¸€ä¸ªargumentçš„æ—¶å€™è¯¢é—®ä¸€æ¬¡ç”¨æˆ·ã€‚
- -n num åé¢åŠ æ¬¡æ•°ï¼Œè¡¨ç¤ºå‘½ä»¤åœ¨æ‰§è¡Œçš„æ—¶å€™ä¸€æ¬¡ç”¨çš„argumentçš„ä¸ªæ•°ï¼Œé»˜è®¤æ˜¯ç”¨æ‰€æœ‰çš„ã€‚
- -t è¡¨ç¤ºå…ˆæ‰“å°å‘½ä»¤ï¼Œç„¶åå†æ‰§è¡Œã€‚
- -i æˆ–è€…æ˜¯-Iï¼Œè¿™å¾—çœ‹linuxæ”¯æŒäº†ï¼Œå°†xargsçš„æ¯é¡¹åç§°ï¼Œä¸€èˆ¬æ˜¯ä¸€è¡Œä¸€è¡Œèµ‹å€¼ç»™ {}ï¼Œå¯ä»¥ç”¨ {} ä»£æ›¿ã€‚
- -r no-run-if-empty å½“xargsçš„è¾“å…¥ä¸ºç©ºçš„æ—¶å€™åˆ™åœæ­¢xargsï¼Œä¸ç”¨å†å»æ‰§è¡Œäº†ã€‚
- -s num å‘½ä»¤è¡Œçš„æœ€å¤§å­—ç¬¦æ•°ï¼ŒæŒ‡çš„æ˜¯ xargs åé¢é‚£ä¸ªå‘½ä»¤çš„æœ€å¤§å‘½ä»¤è¡Œå­—ç¬¦æ•°ã€‚
- -L num ä»æ ‡å‡†è¾“å…¥ä¸€æ¬¡è¯»å– num è¡Œé€ç»™ command å‘½ä»¤ã€‚
- -l åŒ -Lã€‚
- -d delim åˆ†éš”ç¬¦ï¼Œé»˜è®¤çš„xargsåˆ†éš”ç¬¦æ˜¯å›è½¦ï¼Œargumentçš„åˆ†éš”ç¬¦æ˜¯ç©ºæ ¼ï¼Œè¿™é‡Œä¿®æ”¹çš„æ˜¯xargsçš„åˆ†éš”ç¬¦ã€‚
- -x exitçš„æ„æ€ï¼Œä¸»è¦æ˜¯é…åˆ-sä½¿ç”¨ã€‚ã€‚
- -P ä¿®æ”¹æœ€å¤§çš„è¿›ç¨‹æ•°ï¼Œé»˜è®¤æ˜¯1ï¼Œä¸º0æ—¶å€™ä¸ºas many as it can ï¼Œè¿™ä¸ªä¾‹å­æˆ‘æ²¡æœ‰æƒ³åˆ°ï¼Œåº”è¯¥å¹³æ—¶éƒ½ç”¨ä¸åˆ°çš„å§ã€‚

#### ä¾‹1 æ ¼å¼åŒ–è¾“å‡º

xargs ç”¨ä½œæ›¿æ¢å·¥å…·ï¼Œè¯»å–è¾“å…¥æ•°æ®é‡æ–°æ ¼å¼åŒ–åè¾“å‡ºã€‚

å®šä¹‰ä¸€ä¸ªæµ‹è¯•æ–‡ä»¶ï¼Œå†…æœ‰å¤šè¡Œæ–‡æœ¬æ•°æ®ï¼š

```shell
cat test.txt
```

> a b c d e f g
> h i j k l m n
> o p q
> r s t
> u v w x y z

å¤šè¡Œè¾“å…¥å•è¡Œè¾“å‡ºï¼š

```shell
cat test.txt | xargs

```

> a b c d e f g h i j k l m n o p q r s t u v w x y z

-n é€‰é¡¹å¤šè¡Œè¾“å‡ºï¼š

```shell
cat test.txt | xargs -n3
```

> a b c
> d e f
> g h i
> j k l
> m n o
> p q r
> s t u
> v w x
> y z

#### ä¾‹äºŒ  å¤åˆ¶x1æ–‡ä»¶å¤¹ä¸­ï¼Œé™¤äº†x2æ–‡ä»¶çš„å…¶ä»–æ–‡ä»¶åˆ°x3æ–‡ä»¶å¤¹

è¿™é‡Œä½“ç°äº†-içš„ç”¨æ³•

```shell
ls x1/ | grep -v x2 | xargs -i cp -r x1/{} x3/  
```

### cpio

ç”¨äºå¤‡ä»½ã€æ‰“åŒ…ï¼Œå¤è€çš„å·¥å…·ï¼Œè¢«tarç­‰æ›¿ä»£

### [rsync](https://gist.github.com/ilife5/8c5ba280c0c4f84db78a)

æ–‡ä»¶åŒæ­¥å·¥å…·ï¼Œå¯ä»¥åŒä¸¤ä¸ªè¿œç«¯æœºå™¨çš„ç›®å½•ï¼Œä¹Ÿå¯ä»¥åŒæ­¥ä¸¤ä¸ªæœ¬åœ°ç›®å½•ã€‚

å¯ä»¥è®¾ç½®æ’é™¤ç›®å½•ï¼ŒåŸºæœ¬è¯­æ³•

- -v: æ‰“å°å‘½ä»¤æ‰§è¡Œè¿‡ç¨‹ä¸­çš„è¯¦ç»†ä¿¡æ¯
- -r: é€’å½’æ‹·è´æ•°æ®ï¼ˆåœ¨ä¼ é€’æ–‡ä»¶çš„è¿‡ç¨‹ä¸­ä¸ä¼šä¿ç•™æƒé™ä¿¡æ¯ä»¥åŠæ—¶é—´æˆ³ï¼‰
- -a: å½’æ¡£æ¨¡å¼ï¼Œå¯ä»¥å…è®¸é€’å½’æ‹·è´æ•°æ®ï¼Œå¹¶ä¸”ä¿ç•™é“¾æ¥ç¬¦å·ï¼Œæ–‡ä»¶æƒé™ï¼Œç”¨æˆ·å’Œç”¨æˆ·ç»„çš„å½’å±ï¼Œæ—¶é—´æˆ³ã€‚è¿™ä¸€ä¸ªaï¼Œç›¸å½“äºå¥½å¤šå‚æ•°çš„åˆä½“
- -z: å‹ç¼©æ•°æ®
- -h: å¯è¯»æ¨¡å¼ï¼Œè¾“å‡ºå¯è¯»çš„æ•°å­—æ ¼å¼

- -Pï¼šå¤§å†™ï¼Œå¼€å¯æ–­ç‚¹ç»­ä¼ ï¼ŒåŒæ—¶æ˜¾ç¤ºè¿›åº¦ï¼Œå³ -p --progressï¼›

- -pï¼šæ–­ç‚¹ç»­ä¼ ï¼›

- `--progress`ï¼šæ˜¾ç¤ºè¿›åº¦ï¼›

- -eï¼šæŒ‡ç¤ºrsyncç”¨sshç™»å½•ï¼Œç»™å‡ºportå’Œusernameï¼›

- --bwlimitï¼šæ˜¾ç¤ºå¸¦å®½ï¼Œé»˜è®¤å•ä½æ˜¯KBï¼›

- -rï¼šrecursiveï¼›ï¼ˆä¸€èˆ¬ç”¨-aåŒ…å«äº†-rï¼‰

- -lï¼šcopy symlinks as symlinksï¼›

- `--exclude`ï¼šæ’é™¤å“ªäº›æ–‡ä»¶

  > è¿™ä¸ªPATTERNæ˜¯globï¼Œä¸æ˜¯reã€‚
  >
  > --exclude='cache/'ï¼Œæ’é™¤è·¯å¾„ä¸­æ‰€æœ‰çš„cacheç›®å½•ï¼›ï¼ˆä¸èƒ½å†™æˆ 'cache'ï¼Œå«ä¹‰ä¸åŒï¼‰
  >
  > --exclude='cache'ï¼Œæ’é™¤è·¯å¾„ä¸­æ‰€æœ‰cacheç›®å½•ï¼Œæˆ–ä»¥cacheä¸ºåç§°çš„æ–‡ä»¶ï¼›
  >
  > --exclude='cache*'ï¼Œæ’é™¤cacheå¼€å¤´çš„æ–‡ä»¶å’Œç›®å½•ï¼›
  >
  > --exclude='/cache'ï¼Œæ’é™¤ç¬¬1å±‚è·¯å¾„ä¸­çš„cacheï¼ˆç›®å½•æˆ–æ–‡ä»¶ï¼‰ï¼›
  >
  > --exclude='*/cache'ï¼Œæ’é™¤ç¬¬2å±‚è·¯å¾„ä»¥åŠåé¢çš„è·¯å¾„ä¸­çš„æ‰€æœ‰cacheï¼ˆç›®å½•æˆ–æ–‡ä»¶ï¼‰
  >
  > --exclude='cache/*'ï¼Œæ’é™¤cacheç›®å½•ä¸­çš„æ‰€æœ‰æ–‡ä»¶ï¼Œä½†æ˜¯ä¿ç•™cacheè¿™ä¸ªç›®å½•ï¼›

[å¸¸ç”¨ç”¨æ³•](https://gist.github.com/ilife5/8c5ba280c0c4f84db78a)

[å…¶ä»–æ•™ç¨‹](https://www.ruanyifeng.com/blog/2020/08/rsync.html)

