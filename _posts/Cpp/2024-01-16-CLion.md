---
layout: page-with-sidebar
title:  "CLion"
date:   2024-01-16 9:47:03 +0800
author: reflectt6
categories: "C和C++"
mainTag: "编程基础"
secondaryTag: "C和C++"
hideTag: false
---

## 介绍

IntelliJ全家桶中运行C++/C代码的工具。弊端是`只能用CMakeLists管理项目`，如果不会CMakeLists直接寄（虽然CMakeLists确实是比较先进啦）。

常规用途和IDEA基本没啥区别，这里只记录踩坑。



## 远程调试

clion远程调试有几种方式

### 1、目录映射的方式，连接远端gdbserver（推荐）

1、本地配置远程ToolChains

2、建立本地和远端代码的映射关系Mappings

3、远端服务器安装gdbserver并启动

```shell
gdbserver --version
## 调试二进制 注意运行之前一定要编译debug版本，release版本没有符号表信息，是无法调试的
gdbserver :1234 ./omtest 

## 调试JAVA进程中的native代码
gdbserver :1234 --attach pid
```

4、本地clion配置remote debug，设置远端ip和端口号，目录映射

### 2、Clion自带的Remote Development（最不靠谱，强依赖环境、SSH等，配起来很麻烦，因为连接过程对于用户来说是黑盒，而且有什么问题也不会明确报错给你，全靠猜，不友好）

原理应该和第一种方法差不多，但是要求更严格一些。

具体要求见[这里](https://www.jetbrains.com/help/idea/prerequisites.html#min_requirements){:target="_blank"}。官方明说了这个功能还在开发阶段，当不满足最小要求时，不对后续任何报错提供帮助

只要要满足：设置SSH端口转发等条件。比较苛刻（过程待补充）

```shell
#无论是本地端口转发还是远程端口转发，都需要在服务器上配置 /etc/ssh/sshd_config：
GatewayPorts yes
#如果长时间保持连接，那么还需要开启：
TCPKeepAlive yes

# 重启服务
service sshd restart
```

### 3、在远端服务下载linux版本的clion，本地运行调试（也不太靠谱，因为要投影图形化页面，配起来也不简单）

需要配置图形化页面转发等（过程待补充）

```shell
vim /etc/ssh/sshd_config
X11Forwarding yes
service sshd restart
```



## 常见问题

### 0、调试实践

虽然Clion中提供了remote development和remote tools chain。但是这些用起来会有各种问题。在条件允许的情况下，优先在代码运行环境下安装clion。目前clion提供ubuntu的版本。



### 1、Clion调试动态库

有时候，我们有动态库的代码，而动态库被其他程序（甚至是java程序调用）。这时我们无法通过常规方式，在clion中启动任务进行调试。这时候我们可以通过`Run`->`Attach to process`附加到本地环境的进程中去。

这种方式下调试，可能会遇到断点打不进去的问题。这是由于编译时没有保留符号表等调试信息导致。而且我们的程序中可能包含多个库，有些库是debug版本，有些库是release版本，这可能导致有些代码可以断点，有些代码无法断点。





## CMakeLists

### add_subdirectory 子项目管理

CMakeLists中通过add_subdirectory来添加子项目，例如子项目可能是这种结构：

```lua
rocksdb/
|-- CMakeLists.txt (主要)
|-- src/
|   |-- CMakeLists.txt (子目录1)
|   |-- file1.cpp
|   |-- file2.cpp
|-- include/
|   |-- CMakeLists.txt (子目录2)
|   |-- header1.h
|   |-- header2.h
|-- examples/
    |-- CMakeLists.txt (子目录3)
    |-- test1.cpp
    |-- test2.cpp
```

实战：在下载rocksdb源码之后，发现子项目example无法被clion识别。我们的目的是在CLion中调试。

examples中有readme.md如下：

```shell
1. Compile RocksDB first by executing `make static_lib` in parent dir
2. Compile all examples: `cd examples/; make all`
```

按照他的指示确实可以成功构建出来example的二进制文件，并且确实可以跑。但是CLion中代码报红，无法调试。

通过查看最外层的父亲CMakeLists，发现有如下代码：

```cmake
option(WITH_EXAMPLES "build with examples" OFF)
	if(WITH_EXAMPLES)
	add_subdirectory(examples)
endif()
```

也就是说父CMakeLists，跳过了examples这个子项目，那我把OFF改为ON是不是就行了呢？我这边测试了一下，并不行，截止CLion2022.3版本，CLion并不能很好的识别option中对于OFF和ON的设置。

于是我们直接注释掉这个条件，让主CMakeLists强制包含子项目exmaples。

```cmake
#option(WITH_EXAMPLES "build with examples" ON)
#if(WITH_EXAMPLES)
add_subdirectory(examples)
#endif()
```

应用修改，发现examples中的例子可以调试了，至此终于可以愉快的调试源码了。
