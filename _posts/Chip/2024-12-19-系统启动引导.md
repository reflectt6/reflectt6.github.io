---
layout: page-with-sidebar
title:  "系统启动引导"
date:   2024-12-19 9:47:03 +0800
author: reflectt6
categories: "底层和芯片"
mainTag: "底层和芯片"
secondaryTag: "底层"
hideTag: false

---

## BMC

用于烧录FLASH固件

- gpt

  ### **BMC（Baseboard Management Controller）**

  **BMC（Baseboard Management Controller）** 是服务器和嵌入式系统中的一部分，用于管理、监控和控制硬件组件的运行状态。BMC 是 **IPMI（Intelligent Platform Management Interface，智能平台管理接口）** 的核心组件，通过专用的管理通道和网络接口提供硬件级的监控和远程管理功能。

  ------

  #### **1. BMC 的功能**

  1. **硬件健康监控**
     - 实时监控硬件传感器（例如温度、风扇转速、电压、电源状态）。
     - 记录并报告系统中的硬件故障信息。
  2. **电源管理**
     - 启动、关闭或重启服务器，即使操作系统无法运行（例如系统宕机时）。
     - 通过远程管理接口实现电源控制。
  3. **远程管理**
     - 提供远程控制台访问功能（包括虚拟键盘、视频、鼠标功能，称为 KVM over IP）。
     - 支持固件更新和操作系统安装。
  4. **日志记录与告警**
     - 提供硬件运行日志（如 SEL，System Event Log，系统事件日志）。
     - 检测异常情况并通过邮件或网络协议发出告警（例如 SNMP traps）。
  5. **系统启动管理**
     - 控制启动顺序、修改 BIOS/UEFI 设置。
     - 支持虚拟介质加载（例如远程挂载 ISO 文件）。

  ------

  #### **2. BMC 的核心协议与标准**

  1. **IPMI（Intelligent Platform Management Interface）**
     - **作用**：BMC 的操作大多遵循 IPMI 标准，IPMI 定义了一套标准化接口，用于管理和监控设备。
     - **特点**：支持独立于操作系统的管理能力，即使主处理器崩溃或未运行操作系统，也可通过 BMC 进行管理。
  2. **Redfish 协议**
     - **作用**：为现代 BMC 提供替代 IPMI 的 RESTful API 标准。
     - **特点**：更适合现代云计算和数据中心，具有易于扩展和集成的特性。

  ------

  #### **3. BMC 的架构**

  - **专用微处理器**：BMC 是一个独立于主 CPU 的专用芯片。

  - **专用存储**：包含其固件和运行所需的程序。

  - **监控接口**：连接硬件传感器。

  - **网络接口**：支持远程管理，通过 LAN 接口与管理平台连接。

  - 通信总线

    ：

    - SMBus 或 I²C：与硬件传感器、风扇、电源等通信。
    - PCI 或其它内部总线：访问系统数据和状态。

  ------

  #### **4. BMC 在系统中的位置**

  BMC 嵌入在主板上，与系统内的其他组件协同工作。例如：

  - 读取温度、风扇、供电模块的信息。
  - 通过专用接口（如 IPMI 或 Redfish）与外部管理系统通信。

  下图展示了一个典型的 BMC 架构：

  ```
             +----------------+
             |   Remote Mgmt  |
             |  (IPMI/Redfish)|
             +-------+--------+
                     |
            +--------+--------+
            |       BMC        |
            +--------+--------+
                     |
    +--------+-------+-----+-----------+
    | Sensors | Power | Fan | Network  |
    +-------------------------------+---+
  ```

  ------

  #### **5. BMC 的优点**

  - **硬件独立性**：即使系统操作系统未启动或崩溃，也能访问硬件管理功能。
  - **远程管理能力**：尤其适合分布式数据中心和云计算环境。
  - **自动化功能**：如系统启动时自动检查故障硬件状态。

  ------

  #### **6. 应用场景**

  - 服务器管理

    ：

    - 数据中心的服务器硬件远程监控和维护。

  - 嵌入式系统

    ：

    - 高可靠性环境中，对设备的远程硬件诊断。

  - 企业 IT 基础设施

    ：

    - 确保硬件稳定性和快速响应。

  ------

  #### **7. BMC 的品牌实现**

  1. **戴尔 iDRAC（Integrated Dell Remote Access Controller）**
  2. **惠普 iLO（Integrated Lights-Out）**
  3. **IBM IMM（Integrated Management Module）**
  4. **华为 iBMC**
  5. **Supermicro IPMI**

  ------

  ### **总结**

  BMC 是服务器和嵌入式系统中关键的硬件管理组件，其通过专用的管理通道和协议（如 IPMI 和 Redfish）提供独立于操作系统的硬件监控和管理功能。BMC 广泛应用于数据中心和企业 IT 管理中，以提高设备的可靠性、可维护性和响应速度。





## BIOS、EFI、UEFI

- gpt

  **EFI、UEFI 和 BIOS** 是与计算机启动过程相关的三种技术，每种都在一定时间内承担着启动系统的职责。以下分别介绍它们的定义、功能、区别和联系。

  ------

  ### **1. BIOS（Basic Input/Output System）**

  #### **定义**

  BIOS 是最早的固件接口，用于在计算机启动时初始化硬件并加载操作系统。它是 IBM PC 和兼容机启动的重要组成部分。

  #### **功能**

  1. **硬件初始化**：检测和初始化CPU、内存、存储设备等。

  2. **POST（Power-On Self-Test）**：进行基本的硬件测试，确保设备工作正常。

  3. 引导加载器

     ：

     - 查找存储设备中的主引导记录（MBR）。
     - 加载 MBR 引导程序。

  4. **I/O 操作**：提供基础的输入输出操作（如键盘和屏幕控制）。

  #### **局限性**

  - 16 位处理模式（仅支持 1 MB 内存寻址）。
  - 启动设备受限，最大支持容量为 2TB。
  - 不支持图形界面，配置使用键盘和简单的文本菜单。
  - 固定硬编码，与现代硬件扩展性需求不匹配。

  ------

  ### **2. EFI（Extensible Firmware Interface）**

  #### **定义**

  EFI 是由 Intel 在 1990 年代提出的一种固件接口，它克服了 BIOS 的许多限制，为现代计算机提供了更强大的功能和灵活性。

  #### **功能**

  1. **硬件抽象**：提供独立于操作系统的接口，以初始化和控制硬件。

  2. 扩展支持

     ：

     - 可支持大于 2TB 的硬盘。
     - 支持更大的存储块设备，支持 GUID 分区表（GPT）。

  3. 灵活性

     ：

     - 模块化设计，允许增加自定义驱动或功能。
     - 支持驱动程序和其他固件服务的动态加载。

  4. **图形界面**：用户可以通过图形化的界面对固件配置进行操作，而不是简单文本界面。

  5. **引导功能**：支持直接加载操作系统内核，跳过传统 MBR 引导方式。

  #### **局限性**

  - 作为一种最初的设计概念，EFI 的推广有限。
  - 存在与早期 BIOS 兼容性的问题。

  ------

  ### **3. UEFI（Unified Extensible Firmware Interface）**

  #### **定义**

  UEFI 是基于 EFI 发展的新标准，由**UEFI Forum**提出和维护，是现代固件技术的主流选择。

  #### **功能**

  1. 改进的启动功能

     ：

     - 支持大于 2TB 的硬盘，采用 GUID 分区表（GPT）。
     - 能够直接从存储设备加载操作系统内核（跳过传统 MBR 的启动）。

  2. 模块化设计

     ：

     - 支持第三方扩展（如驱动程序和自定义工具）。
     - 提供灵活的扩展能力。

  3. **图形化用户界面（GUI）**：相比 BIOS 的文本界面，提供直观友好的交互方式。

  4. 安全性增强

     ：

     - 支持安全启动（Secure Boot），验证系统启动过程中的软件完整性。
     - 依赖加密签名的机制防止未授权的操作系统或驱动加载。

  5. **32/64 位模式**：支持现代处理器，提升处理速度和运行能力。

  6. **支持多平台**：UEFI 不仅用于 x86 系统，还广泛用于 ARM 等现代架构。

  ------

  ### **区别**

  | 特性           | **BIOS**                     | **EFI**                | **UEFI**                     |
  | -------------- | ---------------------------- | ---------------------- | ---------------------------- |
  | **诞生时间**   | 1970-1980 年代初             | 1990 年代后期          | 2000 年代                    |
  | **位宽支持**   | 16 位（低效）                | 32 位（改进）          | 32/64 位（现代系统支持）     |
  | **支持分区表** | MBR，仅支持 2TB 内存以下硬盘 | GPT 支持 2TB 以上硬盘  | GPT 支持 2TB 以上硬盘        |
  | **安全性**     | 无安全功能                   | 提供扩展安全性         | 支持 Secure Boot（安全启动） |
  | **接口**       | 基于键盘的文本界面           | 简单 GUI               | 图形界面，多种交互方式       |
  | **兼容性**     | 面向老硬件                   | 对新旧硬件都有一定支持 | 广泛支持现代和未来的硬件系统 |

  ------

  ### **联系**

  1. **EFI 是 BIOS 的继任者**，改进了许多 BIOS 的缺点，支持更大的存储和复杂系统配置。
  2. **UEFI 是对 EFI 的升级**，其组织标准化 EFI，为现代计算提供全面支持，成为主流选择。
  3. 现代系统中 **UEFI 通常支持 BIOS 模拟模式（CSM，Compatibility Support Module）**，以兼容老旧的启动方法。

  ------

  ### **总结**

  - **BIOS** 是早期系统的基础固件接口，有较大局限性。
  - **EFI** 作为过渡，解决了一些问题，但应用范围较小。
  - **UEFI** 是当前主流技术，其性能、安全性、扩展性满足了现代计算设备的需求，成为固件的新标准。



## BIOS启动流程

- gpt

  在系统启动过程中，特别是在现代计算机和嵌入式系统中，诸多阶段性模块负责初始化和引导系统。这些模块多见于传统 **BIOS** 或现代 **UEFI** 固件架构。下面介绍 **SEC（Security Phase）**、**PEI（Pre-EFI Initialization）**、**IMF（Interrupt Management Framework）**、**ATF（Arm Trusted Firmware）**、**DXE（Driver Execution Environment）**、**BDS（Boot Device Selection）** 和 **TSL（Trusted Secure Layer）** 的功能及角色。

  ------

  ### **1. SEC（Security Phase）**

  - **作用**：引导最初阶段，保证系统在可信环境中启动。

  - 特点

    ：

    - 是 UEFI 固件的最初阶段。
    - 初始化最小的硬件资源，提供最基本的运行环境。

  - 职责

    ：

    1. 设置 CPU 的初始状态（如关闭中断）。
    2. 验证固件完整性，确保没有被篡改。
    3. 为下一阶段（PEI）加载和启动基础环境。

  - 关键内容

    ：

    - 系统加电和复位后立即执行，直接从 Boot ROM 开始。

  ------

  ### **2. PEI（Pre-EFI Initialization Phase）**

  - **作用**：初始化处理器、芯片组和内存控制器，为加载下一阶段固件提供平台。

  - 特点

    ：

    - 加载阶段初始的 PEI 模块，内存操作受限。

  - 职责

    ：

    1. 检测并初始化临时内存（如 SRAM 或较早期配置的 DRAM）。
    2. 设置主存储器的可用性（如 DDR 初始化）。
    3. 建立系统初始配置表供后续阶段调用。

  - **目标**： 将系统准备好交付给 DXE 阶段，开始运行更高级别的固件代码。

  ------

  ### **3. IMF（Interrupt Management Framework）**

  - **作用**：管理和分配中断系统，是与硬件抽象层及操作系统相关的框架。

  - 职责

    ：

    1. 提供中断服务支持，包括优先级管理和多处理器中断分配。
    2. 向系统各层模块（例如操作系统和固件）提供一致的中断接口。

  - 在启动中的作用

    ：

    - 多见于操作系统加载后，其配置需由系统启动过程中的初始化程序（例如 PEI 或 ATF）逐步完成。

  ------

  ### **4. ATF（Arm Trusted Firmware）**

  - **作用**：适用于 ARM 架构的可信引导框架，为系统安全性提供初始支持。

  - 特点

    ：

    - 通常包含在 Arm 平台的启动过程。
    - 提供安全世界（Secure World）和普通世界（Non-Secure World）切换机制。

  - 职责

    ：

    1. 管理安全特权状态，支持可信启动和加密服务。
    2. 提供异常级别管理（例如 EL3 的固件管理）。

  - 阶段角色

    ：

    - 在 ARM 的安全性要求场景下，与 TEE（Trusted Execution Environment）搭配工作。

  ------

  ### **5. DXE（Driver Execution Environment）**

  - **作用**：UEFI 固件的核心阶段，主要负责硬件抽象及操作系统前环境的运行。

  - 特点

    ：

    - 灵活加载所需的驱动程序，为平台提供设备驱动支持。
    - 支持动态服务扩展和外设初始化。

  - 职责

    ：

    1. 加载和执行 DXE 驱动程序，管理系统硬件。
    2. 初始化系统设备并为其加载相关功能模块。
    3. 准备启动设备，使操作系统可以访问必要的资源。

  - **结果**： 在最终引导操作系统前完成所有硬件环境初始化。

  ------

  ### **6. BDS（Boot Device Selection Phase）**

  - **作用**：负责选择引导设备并加载引导程序。

  - 特点

    ：

    - 是引导链条中操作系统加载阶段的开始。
    - 支持多种启动模式（本地磁盘、网络 PXE、外接设备）。

  - 职责

    ：

    1. 检查并选择引导设备。
    2. 调用操作系统引导程序（如 GRUB 或 Windows Boot Manager）。

  - **目标**： 成功加载操作系统启动程序并将控制权移交给它。

  ------

  ### **7. TSL（Trusted Secure Layer）**

  - **作用**：提供可信的安全层，一般用于确保启动和运行环境的完整性和防篡改。

  - 特点

    ：

    - 多用于带有强安全需求的设备（如嵌入式系统或服务器）。
    - 通常涉及加密硬件（如 TPM）和安全固件服务。

  - 职责

    ：

    1. 在启动过程中验证系统固件和加载内容的真实性。
    2. 提供对受信设备（如 TPM 或硬件密钥）的支持。
    3. 确保设备运行过程中安全机制的可靠性。

  ------

  ### **整体启动流程总结**

  现代系统的启动由这些模块有序协作，典型流程如下：

  1. **SEC 阶段**：上电、运行基本启动程序，确保硬件和固件可信。
  2. **PEI 阶段**：初始化存储器等基础硬件，搭建最基本的运行环境。
  3. **DXE 阶段**：加载驱动程序，完成设备初始化，准备启动环境。
  4. **BDS 阶段**：查找引导设备，加载操作系统启动程序。
  5. **TSL 和 ATF**：在整个流程中提供可信启动支持和安全管理。





## IMU、SCP、DDRC、IPU、IMP

计算机上电后通过BIOS逐步激活IMU、SCP、DDRC、IPU、IMP模块

- gpt

  在复杂的片上系统（SoC）中，系统启动过程涉及多个模块协作，它们负责从初始上电到操作系统运行时各个阶段的关键功能。这些模块各有职责，以下是 **IMU（Image Management Unit）**、**IPU（Image Processing Unit）**、**SCP（System Control Processor）**、**DDRC（DRAM Controller）**、**IMP（Image Management Processor）** 和 **LinxCore** 的作用介绍及其在启动过程中的角色：

  ------

  ### **1. IMU（Image Management Unit）**

  - **作用**：负责引导过程中的固件、启动镜像或配置文件的管理。它可能从存储设备（如 Flash）中加载启动文件，或直接提供对片上 ROM 镜像的访问。

  - 在启动过程中的角色

    ：

    - 识别存储介质中的启动镜像（Boot Image）。
    - 解析镜像结构，将关键部分加载到系统的执行位置（如 DRAM 或 SRAM）。

  ------

  ### **2. IPU（Image Processing Unit）**

  - **作用**：通常是为处理图像、视频流等任务的硬件加速模块。

  - 在启动过程中的角色

    ：

    - 与启动流程关系不直接。IPU 的配置和加载通常是系统初始化稍后或操作系统加载完成后完成的。
    - 可能配合显示模块，呈现启动时的简单 UI 或调试图像。

  ------

  ### **3. SCP（System Control Processor）**

  - **作用**：处理片上系统的低级管理任务，包括电源管理、复位控制、低速外设初始化和通信管理。

  - 在启动过程中的角色

    ：

    1. 早期启动阶段

       ：

       - 配合 BootROM，控制电源域的上电。
       - 负责各个模块的复位、初始化时钟和供电配置。

    2. 协调模块交互

       ：

       - 激活主要的处理单元（如 CPU、GPU 等）以及外设控制器（如 DDRC）。
       - 管理 SoC 的内存映射表等硬件资源。

    3. 电源管理

       ：

       - 初始化系统电源管理方案，确定启动后设备的工作状态（低功耗模式、完全启动等）。

  ------

  ### **4. DDRC（DRAM Controller）**

  - **作用**：DRAM（动态随机存储器）的控制器，负责 SoC 与外部 DDR 内存的通信管理，包括地址映射、刷新调度等。

  - 在启动过程中的角色

    ：

    - **内存初始化**：上电后首先被 SCP 启动，用于配置 DRAM 的参数（如频率、时序等）。

    - 加载启动数据

      ：

      - 从存储设备读取的启动镜像会被 DDRC 加载到内存，为 CPU 执行做好准备。

    - **内存维护**：包括周期性的 DRAM 刷新以确保内存数据的稳定性。

  ------

  ### **5. IMP（Image Management Processor）**

  - **作用**：IMP 是一种专门管理镜像文件、图像数据或编解码的协处理器，可能参与引导过程中的镜像加载和初始化。

  - 在启动过程中的角色

    ：

    - 负责复杂引导镜像的解包（如 gzip、xz 压缩包的解压）和传输到主存储器。
    - 执行对启动镜像的验证，如校验哈希值，确保系统的启动安全性。

  ------

  ### **6. LinxCore**

  - **作用**：通常是 SoC 内的一种处理内核或专用 IP（可能与 Linux 相关联），为用户和开发者提供了更高层的硬件抽象。

  - 在启动过程中的角色

    ：

    - 在操作系统加载完成之后，作为硬件抽象层与 OS 通信。
    - 它可能是基于特定硬件环境优化的一部分，加快 Linux 的引导速度。

  ------

  ### **系统启动过程中的模块交互**：

  以下是启动各阶段及模块的配合流程：

  1. **上电与复位**：
     - **SCP** 初始化电源、时钟，并解除所有关键模块的复位状态。
     - BootROM 开始运行，引导控制交由 **IMU**。
  2. **镜像加载**：
     - **IMU** 根据预先定义的存储路径加载 Bootloader 镜像。
     - 若镜像有压缩或加密，需要由 **IMP** 完成解压和解密。
  3. **内存初始化**：
     - **DDRC** 配置并初始化 DRAM，用于存储接下来的操作系统或内核数据。
     - 镜像数据或执行代码由 DDRC 写入 DRAM。
  4. **操作系统加载**：
     - 操作系统加载过程中，可能调用 **IPU** 生成简单的图像或状态提示界面（如开机 Logo）。
     - **LinxCore** 在 OS 完成初始化后，协助实现硬件到软件的抽象。
  5. **正常运行**：
     - 启动完成后，各个模块（如 IPU、SCP）分别投入到对应的功能任务中。

  ------

  ### **总结**

  这些模块分工明确又密切配合：

  - **IMU、IMP**：主要处理引导镜像。
  - **DDRC**：提供核心内存支持。
  - **SCP**：控制启动流程，协调模块工作。
  - **IPU 和 LinxCore**：在更高层提供图像处理和软件支持。

  从启动到运行，各模块共同确保 SoC 的功能可靠性和启动效率。
