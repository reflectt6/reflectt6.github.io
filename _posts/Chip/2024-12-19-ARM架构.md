---
layout: page-with-sidebar
title:  "ARM架构"
date:   2024-12-19 9:47:03 +0800
author: reflectt6
categories: "底层和芯片"
mainTag: "底层和芯片"
secondaryTag: "底层"
hideTag: false

---

## EL层级

- gpt

  在 ARM 架构中，**EL（Exception Level，异常级别）**是定义系统运行模式和权限级别的一个概念，用于支持不同的操作环境和软件栈。ARM 的 EL 层级分为从低到高的四个主要级别，分别是 EL0、EL1、EL2 和 EL3，每一层对应特定的系统运行状态和权限。

  ------

  ### **ARM 的 EL 层级**

  #### **EL0（用户模式，User Mode）**

  - **权限**：最低权限级别，运行应用程序代码。

  - 功能

    ：

    - 用户应用程序在此层级运行，受操作系统内核管理和约束。
    - 不能直接访问硬件资源，只能通过系统调用请求内核提供服务。

  - **应用场景**：普通的用户空间程序（如浏览器、文件管理器）。

  #### **EL1（内核模式，Kernel Mode）**

  - **权限**：操作系统内核级别，直接控制硬件资源。

  - 功能

    ：

    - 操作系统（如 Linux）运行在 EL1 层，用于管理 CPU、内存、I/O 等硬件资源。
    - 处理来自 EL0 的系统调用，响应中断或异常。

  - 访问能力

    ：

    - 直接访问硬件寄存器、内存和设备。

  - **应用场景**：操作系统内核、驱动程序。

  #### **EL2（虚拟化模式，Hypervisor Mode）**

  - **权限**：虚拟化层，用于运行管理多个操作系统实例的虚拟机监控器（Hypervisor）。

  - 功能

    ：

    - 提供虚拟化支持，允许多个虚拟机同时运行，每个虚拟机内的操作系统运行在 EL1。
    - 隔离虚拟机之间的资源访问，确保安全性。

  - **应用场景**：虚拟化管理程序（如 KVM、Xen 的 Dom0）。

  #### **EL3（安全模式，Secure Monitor Mode）**

  - **权限**：最高权限级别，管理整个系统的安全运行模式。

  - 功能

    ：

    - ARM TrustZone 技术支持，区分普通世界（Non-Secure World）和安全世界（Secure World）。
    - Secure Monitor Code（SMC）在此层级运行，用于在安全世界和普通世界之间切换。
    - 处理来自其他层级的安全异常和控制请求。

  - **应用场景**：安全引导、敏感数据保护、安全应用程序（如 DRM、密码管理）。

  ------

  ### **ARM EL 层级之间的关系**

  | **层级** | **运行模式** | **作用**                             | **权限级别** | **示例**                         |
  | -------- | ------------ | ------------------------------------ | ------------ | -------------------------------- |
  | **EL0**  | 用户模式     | 运行用户程序，受内核管控             | 最低         | 浏览器、文本编辑器等用户程序     |
  | **EL1**  | 内核模式     | 操作系统核心，管理硬件资源           | 中等         | Linux 内核、驱动程序             |
  | **EL2**  | 虚拟化模式   | 管理多个虚拟机，提供虚拟化支持       | 较高         | KVM、Xen Hypervisor              |
  | **EL3**  | 安全模式     | 安全世界与普通世界切换，安全功能管理 | 最高         | TrustZone 安全管理、SMC 指令调用 |

  ------

  ### **ARM TrustZone 与 EL3 的关系**

  - **TrustZone** 是 ARM 提供的一种硬件安全机制，将系统划分为 **安全世界**（Secure World）和 **普通世界**（Non-Secure World）。
  - **EL3** 运行在最高权限级别，用于在这两个世界之间进行切换（通过 SMC 调用），并处理安全相关的任务，如安全存储、加密计算。

  ------

  ### **EL 层级在实际中的工作流示例**

  1. **应用程序运行（EL0）**：
     - 用户操作浏览器，触发对硬件资源（如文件系统）的访问。
     - 发起系统调用，从 EL0 切换到 EL1。
  2. **内核处理（EL1）**：
     - 系统调用由操作系统内核接收和处理（EL1）。
     - 需要访问虚拟化功能时，通过 Hypercall 切换到 EL2。
  3. **虚拟机管理（EL2）**：
     - Hypervisor 在 EL2 层分配和管理虚拟机资源。
     - 如果涉及安全操作，则需要通过 SMC 指令请求 EL3 层。
  4. **安全操作处理（EL3）**：
     - 在 EL3 中完成安全相关的操作（如验证加密密钥）。
     - 返回结果后，再逐步切回到 EL2、EL1 和 EL0，最终将结果返回给用户。

  ------

  ### 小结

  ARM 的 EL 层级提供了一种灵活且分层的安全和性能管理方式：

  - **EL0 和 EL1** 主要处理日常操作（用户空间程序和内核）。
  - **EL2** 提供虚拟化功能，适合多操作系统并行运行场景。
  - **EL3** 是安全的根基，管理系统中最敏感和关键的功能。

  通过这种分层机制，ARM 能够在高效执行和系统安全性之间取得良好平衡，成为现代嵌入式和服务器环境的首选架构之一。
